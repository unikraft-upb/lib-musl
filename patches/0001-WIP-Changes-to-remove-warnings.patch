From 658de3d0e3f9ef46b6f2b00680ad410b3e63a4aa Mon Sep 17 00:00:00 2001
Message-Id: <658de3d0e3f9ef46b6f2b00680ad410b3e63a4aa.1667750808.git.razvan.deaconescu@cs.pub.ro>
From: Razvan Deaconescu <razvan.deaconescu@cs.pub.ro>
Date: Sun, 6 Nov 2022 14:27:09 +0200
Subject: [PATCH] WIP: Changes to remove warnings

Signed-off-by: Razvan Deaconescu <razvan.deaconescu@cs.pub.ro>
---
 include/endian.h             | 11 +++++++++++
 include/net/if.h             |  2 ++
 include/sys/stat.h           |  8 ++++++++
 src/complex/cacos.c          |  1 +
 src/complex/cacosf.c         |  1 +
 src/complex/catan.c          |  1 +
 src/complex/catanf.c         |  1 +
 src/linux/ptrace.c           |  4 ++--
 src/math/cosf.c              |  1 +
 src/math/cosl.c              |  1 +
 src/math/jn.c                |  1 +
 src/math/sinf.c              |  1 +
 src/math/sinl.c              |  1 +
 src/math/tanf.c              |  1 +
 src/math/tanl.c              |  1 +
 src/misc/setrlimit.c         |  5 +++++
 src/network/if_nametoindex.c |  3 ++-
 src/signal/sigaltstack.c     |  1 +
 src/stdio/fgets.c            |  4 ++++
 src/stdio/fread.c            |  4 ++++
 src/stdio/getdelim.c         |  4 ++++
 src/stdio/tempnam.c          |  1 +
 src/stdio/vfprintf.c         |  4 ++++
 src/stdio/vsnprintf.c        |  4 ++++
 src/string/memmem.c          |  4 ++++
 src/string/strlcat.c         |  1 -
 src/string/strstr.c          |  4 ++++
 src/string/wcsstr.c          |  4 ++++
 src/time/strftime.c          |  2 +-
 29 files changed, 76 insertions(+), 5 deletions(-)

diff --git a/include/endian.h b/include/endian.h
index 1bd4445..6899b55 100644
--- a/include/endian.h
+++ b/include/endian.h
@@ -15,10 +15,21 @@
 
 #if defined(_GNU_SOURCE) || defined(_BSD_SOURCE)
 
+#ifndef BIG_ENDIAN
 #define BIG_ENDIAN __BIG_ENDIAN
+#endif
+
+#ifndef BIG_ENDIAN
 #define LITTLE_ENDIAN __LITTLE_ENDIAN
+#endif
+
+#ifndef BIG_ENDIAN
 #define PDP_ENDIAN __PDP_ENDIAN
+#endif
+
+#ifndef BIG_ENDIAN
 #define BYTE_ORDER __BYTE_ORDER
+#endif
 
 #include <stdint.h>
 
diff --git a/include/net/if.h b/include/net/if.h
index 774cbff..460e011 100644
--- a/include/net/if.h
+++ b/include/net/if.h
@@ -7,7 +7,9 @@ extern "C" {
 
 #include <features.h>
 
+#ifndef IF_NAMESIZE
 #define IF_NAMESIZE 16
+#endif
 
 struct if_nameindex {
 	unsigned int if_index;
diff --git a/include/sys/stat.h b/include/sys/stat.h
index 9d09662..76d5143 100644
--- a/include/sys/stat.h
+++ b/include/sys/stat.h
@@ -83,6 +83,14 @@ int mkfifo(const char *, mode_t);
 int mkdirat(int, const char *, mode_t);
 int mkfifoat(int, const char *, mode_t);
 
+int __fxstat(int, int, struct stat *);
+int __fxstatat(int, int, const char *, struct stat *, int);
+int __lxstat(int, const char *, struct stat *);
+int __xstat(int, const char *, struct stat *);
+int __xmknod(int, const char *, mode_t, dev_t *);
+int __xmknodat(int, int, const char *, mode_t, dev_t *);
+
+
 #if defined(_XOPEN_SOURCE) || defined(_GNU_SOURCE) || defined(_BSD_SOURCE)
 int mknod(const char *, mode_t, dev_t);
 int mknodat(int, const char *, mode_t, dev_t);
diff --git a/src/complex/cacos.c b/src/complex/cacos.c
index 27c3563..96c0f8a 100644
--- a/src/complex/cacos.c
+++ b/src/complex/cacos.c
@@ -1,3 +1,4 @@
+#define _GNU_SOURCE
 #include "libm.h"
 
 // FIXME: Hull et al. "Implementing the complex arcsine and arccosine functions using exception handling" 1997
diff --git a/src/complex/cacosf.c b/src/complex/cacosf.c
index 1185265..384eb2a 100644
--- a/src/complex/cacosf.c
+++ b/src/complex/cacosf.c
@@ -1,3 +1,4 @@
+#define _GNU_SOURCE
 #include "libm.h"
 
 // FIXME
diff --git a/src/complex/catan.c b/src/complex/catan.c
index 39ce6cf..c82b615 100644
--- a/src/complex/catan.c
+++ b/src/complex/catan.c
@@ -58,6 +58,7 @@
  * 2.9e-17.  See also clog().
  */
 
+#define _GNU_SOURCE
 #include "libm.h"
 
 #define MAXNUM 1.0e308
diff --git a/src/complex/catanf.c b/src/complex/catanf.c
index 8533bde..f03fc30 100644
--- a/src/complex/catanf.c
+++ b/src/complex/catanf.c
@@ -53,6 +53,7 @@
  *    IEEE      -10,+10     30000        2.3e-6      5.2e-8
  */
 
+#define _GNU_SOURCE
 #include "libm.h"
 
 #define MAXNUMF 1.0e38F
diff --git a/src/linux/ptrace.c b/src/linux/ptrace.c
index a3f393d..39b33d3 100644
--- a/src/linux/ptrace.c
+++ b/src/linux/ptrace.c
@@ -7,7 +7,7 @@ long ptrace(int req, ...)
 {
 	va_list ap;
 	pid_t pid;
-	void *addr, *data, *addr2 = 0;
+	void *addr, *data;
 	long ret, result;
 
 	va_start(ap, req);
@@ -22,7 +22,7 @@ long ptrace(int req, ...)
 	va_end(ap);
 
 	if (req-1U < 3) data = &result;
-	ret = syscall(SYS_ptrace, req, pid, addr, data, addr2);
+	ret = syscall(SYS_ptrace, req, pid, addr, data);
 
 	if (ret < 0 || req-1U >= 3) return ret;
 	return result;
diff --git a/src/math/cosf.c b/src/math/cosf.c
index 23f3e5b..67ead7e 100644
--- a/src/math/cosf.c
+++ b/src/math/cosf.c
@@ -14,6 +14,7 @@
  * ====================================================
  */
 
+#define _GNU_SOURCE
 #include "libm.h"
 
 /* Small multiples of pi/2 rounded to double precision. */
diff --git a/src/math/cosl.c b/src/math/cosl.c
index 79c41c7..66beb61 100644
--- a/src/math/cosl.c
+++ b/src/math/cosl.c
@@ -1,3 +1,4 @@
+#define _GNU_SOURCE
 #include "libm.h"
 
 #if LDBL_MANT_DIG == 53 && LDBL_MAX_EXP == 1024
diff --git a/src/math/jn.c b/src/math/jn.c
index 4878a54..cdbdf0f 100644
--- a/src/math/jn.c
+++ b/src/math/jn.c
@@ -34,6 +34,7 @@
  *      values of n>1.
  */
 
+#define _GNU_SOURCE
 #include "libm.h"
 
 static const double invsqrtpi = 5.64189583547756279280e-01; /* 0x3FE20DD7, 0x50429B6D */
diff --git a/src/math/sinf.c b/src/math/sinf.c
index 64e39f5..01e1b86 100644
--- a/src/math/sinf.c
+++ b/src/math/sinf.c
@@ -14,6 +14,7 @@
  * ====================================================
  */
 
+#define _GNU_SOURCE
 #include "libm.h"
 
 /* Small multiples of pi/2 rounded to double precision. */
diff --git a/src/math/sinl.c b/src/math/sinl.c
index 9c0b16e..5f93152 100644
--- a/src/math/sinl.c
+++ b/src/math/sinl.c
@@ -1,3 +1,4 @@
+#define _GNU_SOURCE
 #include "libm.h"
 
 #if LDBL_MANT_DIG == 53 && LDBL_MAX_EXP == 1024
diff --git a/src/math/tanf.c b/src/math/tanf.c
index aba1977..d7a0bcf 100644
--- a/src/math/tanf.c
+++ b/src/math/tanf.c
@@ -14,6 +14,7 @@
  * ====================================================
  */
 
+#define _GNU_SOURCE
 #include "libm.h"
 
 /* Small multiples of pi/2 rounded to double precision. */
diff --git a/src/math/tanl.c b/src/math/tanl.c
index 6af0671..8106cf3 100644
--- a/src/math/tanl.c
+++ b/src/math/tanl.c
@@ -1,3 +1,4 @@
+#define _GNU_SOURCE
 #include "libm.h"
 
 #if LDBL_MANT_DIG == 53 && LDBL_MAX_EXP == 1024
diff --git a/src/misc/setrlimit.c b/src/misc/setrlimit.c
index 7130d71..c5b51ed 100644
--- a/src/misc/setrlimit.c
+++ b/src/misc/setrlimit.c
@@ -3,7 +3,12 @@
 #include "syscall.h"
 #include "libc.h"
 
+/* Undefine MIN and MAX to prevent double define warnings. */
+#undef MIN
+#undef MAX
+
 #define MIN(a, b) ((a)<(b) ? (a) : (b))
+
 #define FIX(x) do{ if ((x)>=SYSCALL_RLIM_INFINITY) (x)=RLIM_INFINITY; }while(0)
 
 int __setrlimit(int resource, const struct rlimit *rlim)
diff --git a/src/network/if_nametoindex.c b/src/network/if_nametoindex.c
index 331413c..17aad4c 100644
--- a/src/network/if_nametoindex.c
+++ b/src/network/if_nametoindex.c
@@ -11,7 +11,8 @@ unsigned if_nametoindex(const char *name)
 	int fd, r;
 
 	if ((fd = socket(AF_UNIX, SOCK_DGRAM|SOCK_CLOEXEC, 0)) < 0) return 0;
-	strncpy(ifr.ifr_name, name, sizeof ifr.ifr_name);
+	strncpy(ifr.ifr_name, name, sizeof ifr.ifr_name - 1);
+	ifr.ifr_name[sizeof ifr.ifr_name - 1] = '\0';
 	r = ioctl(fd, SIOCGIFINDEX, &ifr);
 	__syscall(SYS_close, fd);
 	return r < 0 ? 0 : ifr.ifr_ifindex;
diff --git a/src/signal/sigaltstack.c b/src/signal/sigaltstack.c
index 62cb81a..1f33387 100644
--- a/src/signal/sigaltstack.c
+++ b/src/signal/sigaltstack.c
@@ -1,3 +1,4 @@
+#define _BSD_SOURCE
 #include <signal.h>
 #include <errno.h>
 #include "syscall.h"
diff --git a/src/stdio/fgets.c b/src/stdio/fgets.c
index d3f9819..ef3698e 100644
--- a/src/stdio/fgets.c
+++ b/src/stdio/fgets.c
@@ -1,6 +1,10 @@
 #include "stdio_impl.h"
 #include <string.h>
 
+/* Undefine MIN and MAX to prevent double define warnings. */
+#undef MIN
+#undef MAX
+
 #define MIN(a,b) ((a)<(b) ? (a) : (b))
 
 char *fgets(char *restrict s, int n, FILE *restrict f)
diff --git a/src/stdio/fread.c b/src/stdio/fread.c
index aef75f7..92474fc 100644
--- a/src/stdio/fread.c
+++ b/src/stdio/fread.c
@@ -1,6 +1,10 @@
 #include "stdio_impl.h"
 #include <string.h>
 
+/* Undefine MIN and MAX to prevent double define warnings. */
+#undef MIN
+#undef MAX
+
 #define MIN(a,b) ((a)<(b) ? (a) : (b))
 
 size_t fread(void *restrict destv, size_t size, size_t nmemb, FILE *restrict f)
diff --git a/src/stdio/getdelim.c b/src/stdio/getdelim.c
index 1ccd802..906c52e 100644
--- a/src/stdio/getdelim.c
+++ b/src/stdio/getdelim.c
@@ -3,6 +3,10 @@
 #include <inttypes.h>
 #include <errno.h>
 
+/* Undefine MIN and MAX to prevent double define warnings. */
+#undef MIN
+#undef MAX
+
 #define MIN(a,b) ((a)<(b) ? (a) : (b))
 
 ssize_t getdelim(char **restrict s, size_t *restrict n, int delim, FILE *restrict f)
diff --git a/src/stdio/tempnam.c b/src/stdio/tempnam.c
index 5a55975..df8ce9d 100644
--- a/src/stdio/tempnam.c
+++ b/src/stdio/tempnam.c
@@ -1,3 +1,4 @@
+#define _BSD_SOURCE
 #include <stdio.h>
 #include <fcntl.h>
 #include <errno.h>
diff --git a/src/stdio/vfprintf.c b/src/stdio/vfprintf.c
index 50fb55c..73e8adb 100644
--- a/src/stdio/vfprintf.c
+++ b/src/stdio/vfprintf.c
@@ -10,6 +10,10 @@
 #include <math.h>
 #include <float.h>
 
+/* Undefine MIN and MAX to prevent double define warnings. */
+#undef MIN
+#undef MAX
+
 /* Some useful macros */
 
 #define MAX(a,b) ((a)>(b) ? (a) : (b))
diff --git a/src/stdio/vsnprintf.c b/src/stdio/vsnprintf.c
index b3510a6..dbba80f 100644
--- a/src/stdio/vsnprintf.c
+++ b/src/stdio/vsnprintf.c
@@ -4,6 +4,10 @@
 #include <errno.h>
 #include <stdint.h>
 
+/* Undefine MIN and MAX to prevent double define warnings. */
+#undef MAX
+#undef MIN
+
 struct cookie {
 	char *s;
 	size_t n;
diff --git a/src/string/memmem.c b/src/string/memmem.c
index 54a66e4..5089443 100644
--- a/src/string/memmem.c
+++ b/src/string/memmem.c
@@ -2,6 +2,10 @@
 #include <string.h>
 #include <stdint.h>
 
+/* Undefine MIN and MAX to prevent double define warnings. */
+#undef MAX
+#undef MIN
+
 static char *twobyte_memmem(const unsigned char *h, size_t k, const unsigned char *n)
 {
 	uint16_t nw = n[0]<<8 | n[1], hw = h[0]<<8 | h[1];
diff --git a/src/string/strlcat.c b/src/string/strlcat.c
index ef81209..a6b94c4 100644
--- a/src/string/strlcat.c
+++ b/src/string/strlcat.c
@@ -1,4 +1,3 @@
-#define _BSD_SOURCE
 #include <string.h>
 
 size_t strlcat(char *d, const char *s, size_t n)
diff --git a/src/string/strstr.c b/src/string/strstr.c
index cd06912..5e04df4 100644
--- a/src/string/strstr.c
+++ b/src/string/strstr.c
@@ -1,6 +1,10 @@
 #include <string.h>
 #include <stdint.h>
 
+/* Undefine MIN and MAX to prevent double define warnings. */
+#undef MIN
+#undef MAX
+
 static char *twobyte_strstr(const unsigned char *h, const unsigned char *n)
 {
 	uint16_t nw = n[0]<<8 | n[1], hw = h[0]<<8 | h[1];
diff --git a/src/string/wcsstr.c b/src/string/wcsstr.c
index 4caaef3..41db7ce 100644
--- a/src/string/wcsstr.c
+++ b/src/string/wcsstr.c
@@ -1,5 +1,9 @@
 #include <wchar.h>
 
+/* Undefine MIN and MAX to prevent double define warnings. */
+#undef MIN
+#undef MAX
+
 #define MAX(a,b) ((a)>(b)?(a):(b))
 #define MIN(a,b) ((a)<(b)?(a):(b))
 
diff --git a/src/time/strftime.c b/src/time/strftime.c
index 708875e..0a25697 100644
--- a/src/time/strftime.c
+++ b/src/time/strftime.c
@@ -181,7 +181,7 @@ const char *__strftime_fmt_1(char (*s)[100], size_t *l, int f, const struct tm *
 			*l = 0;
 			return "";
 		}
-		*l = snprintf(*s, sizeof *s, "%+.2d%.2d",
+		*l = snprintf(*s, sizeof *s, "%+.2ld%.2d",
 			(tm->__tm_gmtoff)/3600,
 			abs(tm->__tm_gmtoff%3600)/60);
 		return *s;
-- 
2.17.1

